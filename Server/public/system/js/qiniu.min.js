!function(global){function createCookie(e,t,r){var n=new Date;n.setTime(n.getTime()+24*r*60*60*1e3);var i="; expires="+n.toGMTString();document.cookie=e+"="+t+i+"; path=/"}function readCookie(e){for(var t=e+"=",r=document.cookie.split(";"),n=0,i=r.length;i>n;n++){for(var o=r[n];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(t))return o.substring(t.length,o.length)}return null}function QiniuJsSDK(){function log(e,t){var r="[qiniu-js-sdk]["+e+"]";if(that.detectIEVersion()){for(var n=r,i=0;i<t.length;i++)n+=that.stringifyJSON(t[i]);console.log(n)}else t.unshift(r),console.log.apply(console,t);if(document.getElementById("qiniu-js-sdk-log")){for(var o=r,a=0;a<t.length;a++)o+=that.stringifyJSON(t[a]);document.getElementById("qiniu-js-sdk-log").innerHTML+="<p>"+o+"</p>"}}function makeLogFunc(e){var t=e.toLowerCase();logger[t]=function(){if(window.console&&window.console.log&&logger.level>=logger[e]){var r=Array.prototype.slice.call(arguments);log(t,r)}}}var that=this;this.detectIEVersion=function(){for(var e=4,t=document.createElement("div"),r=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+e+"]><i></i><![endif]-->",r[0];)e++;return e>4?e:!1};var logger={MUTE:0,FATA:1,ERROR:2,WARN:3,INFO:4,DEBUG:5,TRACE:6,level:0};for(var property in logger)logger.hasOwnProperty(property)&&"number"==typeof logger[property]&&!logger.hasOwnProperty(property.toLowerCase())&&makeLogFunc(property);var qiniuUploadUrl;qiniuUploadUrl="https:"===window.location.protocol?"https://up-z2.qbox.me":"http://up-z2.qiniu.com";var qiniuUploadUrls=["http://up-z2.qiniu.com","http://up.qiniu.com"],changeUrlTimes=0;this.resetUploadUrl=function(){if("https:"===window.location.protocol)qiniuUploadUrl="https://up-z2.qbox.me";else{var e=changeUrlTimes%qiniuUploadUrls.length;qiniuUploadUrl=qiniuUploadUrls[e],changeUrlTimes++}logger.debug("resetUploadUrl: "+qiniuUploadUrl)},this.resetUploadUrl(),this.isImage=function(e){return e=e.split(/[?#]/)[0],/\.(png|jpg|jpeg|gif|bmp)$/i.test(e)},this.getFileExtension=function(e){var t,r=e.split(".");return t=1===r.length||""===r[0]&&2===r.length?"":r.pop().toLowerCase()},this.utf8_encode=function(e){if(null===e||"undefined"==typeof e)return"";var t,r,n=e+"",i="",o=0;t=r=0,o=n.length;for(var a=0;o>a;a++){var s=n.charCodeAt(a),u=null;if(128>s)r++;else if(s>127&&2048>s)u=String.fromCharCode(s>>6|192,63&s|128);else if(63488&s^!0)u=String.fromCharCode(s>>12|224,s>>6&63|128,63&s|128);else{if(64512&s^!0)throw new RangeError("Unmatched trail surrogate at "+a);var l=n.charCodeAt(++a);if(64512&l^!0)throw new RangeError("Unmatched lead surrogate at "+(a-1));s=((1023&s)<<10)+(1023&l)+65536,u=String.fromCharCode(s>>18|240,s>>12&63|128,s>>6&63|128,63&s|128)}null!==u&&(r>t&&(i+=n.slice(t,r)),i+=u,t=r=a+1)}return r>t&&(i+=n.slice(t,o)),i},this.base64_encode=function(e){var t,r,n,i,o,a,s,u,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",g=0,d=0,f="",p=[];if(!e)return e;e=this.utf8_encode(e+"");do t=e.charCodeAt(g++),r=e.charCodeAt(g++),n=e.charCodeAt(g++),u=t<<16|r<<8|n,i=u>>18&63,o=u>>12&63,a=u>>6&63,s=63&u,p[d++]=l.charAt(i)+l.charAt(o)+l.charAt(a)+l.charAt(s);while(g<e.length);switch(f=p.join(""),e.length%3){case 1:f=f.slice(0,-2)+"==";break;case 2:f=f.slice(0,-1)+"="}return f},this.URLSafeBase64Encode=function(e){return e=this.base64_encode(e),e.replace(/\//g,"_").replace(/\+/g,"-")},this.createAjax=function(){var e={};return e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},this.parseJSON=function(data){if(window.JSON&&window.JSON.parse)return window.JSON.parse(data);var rx_dangerous=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,text=String(data);return rx_dangerous.lastIndex=0,rx_dangerous.test(text)&&(text=text.replace(rx_dangerous,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),eval("("+text+")")},this.stringifyJSON=function(e){if(window.JSON&&window.JSON.stringify)return window.JSON.stringify(e);switch(typeof e){case"string":return'"'+e.replace(/(["\\])/g,"\\$1")+'"';case"array":return"["+e.map(that.stringifyJSON).join(",")+"]";case"object":if(e instanceof Array){for(var t=[],r=e.length,n=0;r>n;n++)t.push(that.stringifyJSON(e[n]));return"["+t.join(",")+"]"}if(null===e)return"null";var i=[];for(var o in e)e.hasOwnProperty(o)&&i.push(that.stringifyJSON(o)+":"+that.stringifyJSON(e[o]));return"{"+i.join(",")+"}";case"number":return e;case!1:return e;case"boolean":return e}},this.trim=function(e){return null===e?"":e.replace(/^\s+|\s+$/g,"")},this.uploader=function(e){var t=function(){var t,r,n,i=that.detectIEVersion(),o="Safari"===mOxie.Env.browser&&mOxie.Env.version<=5&&"Windows"===mOxie.Env.os&&"7"===mOxie.Env.osVersion||"Safari"===mOxie.Env.browser&&"iOS"===mOxie.Env.os&&"7"===mOxie.Env.osVersion;i&&9>=i&&e.chunk_size&&e.runtimes.indexOf("flash")<0?e.chunk_size=0:o?e.chunk_size=0:(t=20,r=4<<t,n=plupload.parseSize(e.chunk_size),n>r&&(e.chunk_size=r))},r=function(t){if(e.uptoken)return void(that.token=e.uptoken);{if(!e.uptoken_url)return e.uptoken_func?(logger.debug("get uptoken from uptoken_func"),that.token=e.uptoken_func(t),void logger.debug("get new uptoken: ",that.token)):void logger.error("one of [uptoken, uptoken_url, uptoken_func] settings in options is required!");logger.debug("get uptoken from: ",that.uptoken_url);var r=that.createAjax();if(r.open("GET",that.uptoken_url,!1),r.setRequestHeader("If-Modified-Since","0"),r.send(),200===r.status){var n=that.parseJSON(r.responseText);that.token=n.uptoken,logger.debug("get new uptoken: ",n.uptoken)}else logger.error("get uptoken error: ",r.responseText)}},n=function(t,r,n){var i="",o=!1;if(!e.save_key)if(o=t.getOption&&t.getOption("unique_names"),o=o||t.settings&&t.settings.unique_names){var a=that.getFileExtension(r.name);i=a?r.id+"."+a:r.id}else i="function"==typeof n?n(t,r):r.name;return i};if(e.log_level&&(logger.level=e.log_level),!e.domain)throw"domain setting in options is required!";if(!e.browse_button)throw"browse_button setting in options is required!";if(!e.uptoken&&!e.uptoken_url&&!e.uptoken_func)throw"one of [uptoken, uptoken_url, uptoken_func] settings in options is required!";logger.debug("init uploader start"),logger.debug("environment: ",mOxie.Env),logger.debug("userAgent: ",navigator.userAgent);var i={},o=e.init&&e.init.Error,a=e.init&&e.init.FileUploaded;e.init.Error=function(){},e.init.FileUploaded=function(){},that.uptoken_url=e.uptoken_url,that.token="",that.key_handler="function"==typeof e.init.Key?e.init.Key:"",this.domain=e.domain;var s="",u={isResumeUpload:!1,resumeFilesize:0,startTime:"",currentTime:""};t(),logger.debug("invoke reset_chunk_size()"),logger.debug("op.chunk_size: ",e.chunk_size),plupload.extend(i,e,{url:qiniuUploadUrl,multipart_params:{token:""}}),logger.debug("option: ",i);var l=new plupload.Uploader(i);logger.debug("new plupload.Uploader(option)"),l.bind("Init",function(){logger.debug("Init event activated"),e.get_new_uptoken||r(null)}),logger.debug("bind Init event"),l.bind("FilesAdded",function(e,t){logger.debug("FilesAdded event activated");var r=e.getOption&&e.getOption("auto_start");r=r||e.settings&&e.settings.auto_start,logger.debug("auto_start: ",r),logger.debug("files: ",t),r&&setTimeout(function(){e.start(),logger.debug("invoke up.start()")},0),e.refresh()}),logger.debug("bind FilesAdded event"),l.bind("BeforeUpload",function(t,i){logger.debug("BeforeUpload event activated"),i.speed=i.speed||0,s="",e.get_new_uptoken&&r(i);var o=function(t,r,i){u.startTime=(new Date).getTime();var o;o=e.save_key?{token:that.token}:{key:n(t,r,i),token:that.token},logger.debug("directUpload multipart_params_obj: ",o);var s=e.x_vars;if(void 0!==s&&"object"==typeof s)for(var l in s)s.hasOwnProperty(l)&&("function"==typeof s[l]?o["x:"+l]=s[l](t,r):"object"!=typeof s[l]&&(o["x:"+l]=s[l]));t.setOption({url:qiniuUploadUrl,multipart:!0,chunk_size:a()?e.max_file_size:void 0,multipart_params:o})},a=function(){var e=navigator.userAgent.toLowerCase();return(e.match(/MicroMessenger/i)||"QQBrowser"===mOxie.Env.browser||e.match(/V1_AND_SQ/i))&&"android"===mOxie.Env.OS.toLowerCase()?!0:!1},g=t.getOption&&t.getOption("chunk_size");if(g=g||t.settings&&t.settings.chunk_size,logger.debug("uploader.runtime: ",l.runtime),logger.debug("chunk_size: ",g),"html5"!==l.runtime&&"flash"!==l.runtime||!g)logger.debug("directUpload because uploader.runtime !== 'html5' || uploader.runtime !== 'flash' || !chunk_size"),o(t,i,that.key_handler);else if(i.size<g||a())logger.debug("directUpload because file.size < chunk_size || is_android_weixin_or_qq()"),o(t,i,that.key_handler);else{var d=localStorage.getItem(i.name),f=g;if(d){d=that.parseJSON(d);var p=(new Date).getTime(),c=d.time||0,h=864e5;h>p-c&&100!==d.percent&&i.size===d.total?(i.percent=d.percent,i.loaded=d.offset,s=d.ctx,u.isResumeUpload=!0,u.resumeFilesize=d.offset,d.offset+f>i.size&&(f=i.size-d.offset)):localStorage.removeItem(i.name)}u.startTime=(new Date).getTime(),t.setOption({url:qiniuUploadUrl+"/mkblk/"+f,multipart:!1,chunk_size:g,required_features:"chunks",headers:{Authorization:"UpToken "+that.token},multipart_params:{}})}}),logger.debug("bind BeforeUpload event"),l.bind("UploadProgress",function(e,t){logger.trace("UploadProgress event activated"),u.currentTime=(new Date).getTime();var r=u.currentTime-u.startTime,n=t.loaded||0;u.isResumeUpload&&(n=t.loaded-u.resumeFilesize),t.speed=(n/r*1e3).toFixed(0)||0}),logger.debug("bind UploadProgress event"),l.bind("ChunkUploaded",function(e,t,r){logger.debug("ChunkUploaded event activated"),logger.debug("file: ",t),logger.debug("info: ",r);var n=that.parseJSON(r.response);logger.debug("res: ",n),s=s?s+","+n.ctx:n.ctx;var i=r.total-r.offset,o=e.getOption&&e.getOption("chunk_size");o=o||e.settings&&e.settings.chunk_size,o>i&&(e.setOption({url:qiniuUploadUrl+"/mkblk/"+i}),logger.debug("up.setOption url: ",qiniuUploadUrl+"/mkblk/"+i)),localStorage.setItem(t.name,that.stringifyJSON({ctx:s,percent:t.percent,total:r.total,offset:r.offset,time:(new Date).getTime()}))}),logger.debug("bind ChunkUploaded event");var g=qiniuUploadUrls.length,d=function(e){return g-->0?(setTimeout(function(){that.resetUploadUrl(),e.status=plupload.QUEUED,l.stop(),l.start()},0),!0):(g=qiniuUploadUrls.length,!1)};return l.bind("Error",function(e){return function(t,r){logger.error("Error event activated"),logger.error("err: ",r);var n="",i=r.file;if(i){switch(r.code){case plupload.FAILED:n="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var o=t.getOption&&t.getOption("max_file_size");o=o||t.settings&&t.settings.max_file_size,n="浏览器最大可上传"+o+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:n="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:if(""===r.response){if(n=r.message||"未知网络错误。",!d(i))return;break}var a=that.parseJSON(r.response),s=a.error;switch(r.status){case 400:n="请求报文格式错误。";break;case 401:n="客户端认证授权失败。请重试或提交反馈。";break;case 405:n="客户端请求错误。请重试或提交反馈。";break;case 579:n="资源上传成功，但回调失败。";break;case 599:if(n="网络连接异常。请重试或提交反馈。",!d(i))return;break;case 614:n="文件已存在。";try{a=that.parseJSON(a.error),s=a.error||"file exists"}catch(u){s=a.error||"file exists"}break;case 631:n="指定空间不存在。";break;case 701:n="上传数据块校验出错。请重试或提交反馈。";break;default:if(n="未知错误。",!d(i))return}n=n+"("+r.status+"："+s+")";break;case plupload.SECURITY_ERROR:n="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:n="上传失败。请稍后再试。";break;case plupload.IO_ERROR:n="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:n="网站配置错误。请联系网站管理员。",l.destroy();break;default:if(n=r.message+r.details,!d(i))return}e&&e(t,r,n)}t.refresh()}}(o)),logger.debug("bind Error event"),l.bind("FileUploaded",function(t){return function(r,i,o){logger.debug("FileUploaded event activated"),logger.debug("file: ",i),logger.debug("info: ",o);var a=function(r,n,i){if(e.downtoken_url){var o=that.createAjax();o.open("POST",e.downtoken_url,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status){var e;try{e=that.parseJSON(o.responseText)}catch(a){throw"invalid json format"}var s={};plupload.extend(s,that.parseJSON(i),e),t&&t(r,n,that.stringifyJSON(s))}else l.trigger("Error",{status:o.status,response:o.responseText,file:n,code:plupload.HTTP_ERROR})},o.send("key="+that.parseJSON(i).key+"&domain="+e.domain)}else t&&t(r,n,i)},u=that.parseJSON(o.response);if(s=s?s:u.ctx,logger.debug("ctx: ",s),s){var g="";logger.debug("save_key: ",e.save_key),e.save_key||(g=n(r,i,that.key_handler),g=g?"/key/"+that.URLSafeBase64Encode(g):"");var d="/fname/"+that.URLSafeBase64Encode(i.name);logger.debug("op.x_vars: ",e.x_vars);var f=e.x_vars,p="",c="";if(void 0!==f&&"object"==typeof f)for(var h in f)f.hasOwnProperty(h)&&("function"==typeof f[h]?p=that.URLSafeBase64Encode(f[h](r,i)):"object"!=typeof f[h]&&(p=that.URLSafeBase64Encode(f[h])),c+="/x:"+h+"/"+p);var m,v=qiniuUploadUrl+"/mkfile/"+i.size+g+d+c,k=that.detectIEVersion();k&&9>=k?(m=new mOxie.XMLHttpRequest,mOxie.Env.swf_url=e.flash_swf_url):m=that.createAjax(),m.open("POST",v,!0),m.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),m.setRequestHeader("Authorization","UpToken "+that.token);var b=function(){if(logger.debug("ajax.readyState: ",m.readyState),4===m.readyState){localStorage.removeItem(i.name);var e;200===m.status?(e=m.responseText,logger.debug("mkfile is success: ",e),a(r,i,e)):(e={status:m.status,response:m.responseText,file:i,code:-200},logger.debug("mkfile is error: ",e),l.trigger("Error",e))}};k&&9>=k?m.bind("readystatechange",b):m.onreadystatechange=b,m.send(s),logger.debug("mkfile: ",v)}else a(r,i,o.response)}}(a)),logger.debug("bind FileUploaded event"),l.init(),logger.debug("invoke uploader.init()"),logger.debug("init uploader end"),l},this.getUrl=function(e){if(!e)return!1;e=encodeURI(e);var t=this.domain;return"/"!==t.slice(t.length-1)&&(t+="/"),t+e},this.imageView2=function(e,t){var r=e.mode||"",n=e.w||"",i=e.h||"",o=e.q||"",a=e.format||"";if(!r)return!1;if(!n&&!i)return!1;var s="imageView2/"+r;return s+=n?"/w/"+n:"",s+=i?"/h/"+i:"",s+=o?"/q/"+o:"",s+=a?"/format/"+a:"",t&&(s=this.getUrl(t)+"?"+s),s},this.imageMogr2=function(e,t){var r=e["auto-orient"]||"",n=e.thumbnail||"",i=e.strip||"",o=e.gravity||"",a=e.crop||"",s=e.quality||"",u=e.rotate||"",l=e.format||"",g=e.blur||"",d="imageMogr2";return d+=r?"/auto-orient":"",d+=n?"/thumbnail/"+n:"",d+=i?"/strip":"",d+=o?"/gravity/"+o:"",d+=s?"/quality/"+s:"",d+=a?"/crop/"+a:"",d+=u?"/rotate/"+u:"",d+=l?"/format/"+l:"",d+=g?"/blur/"+g:"",t&&(d=this.getUrl(t)+"?"+d),d},this.watermark=function(e,t){var r=e.mode;if(!r)return!1;var n="watermark/"+r;if(1===r){var i=e.image||"";if(!i)return!1;n+=i?"/image/"+this.URLSafeBase64Encode(i):""}else{if(2!==r)return!1;var o=e.text?e.text:"",a=e.font?e.font:"",s=e.fontsize?e.fontsize:"",u=e.fill?e.fill:"";if(!o)return!1;n+=o?"/text/"+this.URLSafeBase64Encode(o):"",n+=a?"/font/"+this.URLSafeBase64Encode(a):"",n+=s?"/fontsize/"+s:"",n+=u?"/fill/"+this.URLSafeBase64Encode(u):""}var l=e.dissolve||"",g=e.gravity||"",d=e.dx||"",f=e.dy||"";return n+=l?"/dissolve/"+l:"",n+=g?"/gravity/"+g:"",n+=d?"/dx/"+d:"",n+=f?"/dy/"+f:"",t&&(n=this.getUrl(t)+"?"+n),n},this.imageInfo=function(e){if(!e)return!1;var t,r=this.getUrl(e)+"?imageInfo",n=this.createAjax(),i=this;return n.open("GET",r,!1),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&(t=i.parseJSON(n.responseText))},n.send(),t},this.exif=function(e){if(!e)return!1;var t,r=this.getUrl(e)+"?exif",n=this.createAjax(),i=this;return n.open("GET",r,!1),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&(t=i.parseJSON(n.responseText))},n.send(),t},this.get=function(e,t){return t&&e?"exif"===e?this.exif(t):"imageInfo"===e?this.imageInfo(t):!1:!1},this.pipeline=function(e,t){var r,n,i="[object Array]"===Object.prototype.toString.call(e),o="";if(i){for(var a=0,s=e.length;s>a;a++){if(r=e[a],!r.fop)return!1;switch(r.fop){case"watermark":o+=this.watermark(r)+"|";break;case"imageView2":o+=this.imageView2(r)+"|";break;case"imageMogr2":o+=this.imageMogr2(r)+"|";break;default:n=!0}if(n)return!1}if(t){o=this.getUrl(t)+"?"+o;var u=o.length;"|"===o.slice(u-1)&&(o=o.slice(0,u-1))}return o}return!1}}window.localStorage||(window.localStorage={setItem:function(e,t){createCookie(e,t,30)},getItem:function(e){return readCookie(e)},removeItem:function(e){createCookie(e,"",-1)}});var Qiniu=new QiniuJsSDK;global.Qiniu=Qiniu,global.QiniuJsSDK=QiniuJsSDK}(window);